# AgalychnisUCE
Agalychnis (tree frog) UCE analyses

# Data
UCE data were generated by RAPiD Genomics. I obtained a copy of the data, which are stored here:

`/uufs/chpc.utah.edu/common/home/gompert-group4/data/UCE_data`

This includes UCE data for 62 individiuals (a few were miss-labeled, see notes below).

The data were provided by John Wiens, are available from [OSF](https://osf.io/fzw3x/) and were originally published in [Portik et al. 2023](https://academic.oup.com/mbe/article/40/5/msad109/7151539). I specifically used the data from `Final-Trimmed-Alignments.zip`. This includes 3784 UCE alignments. I extracted the sequence for *Agalychnis callidryas* for each UCE alignment (if present), removed any gaps in the alignment and then used the sequence as our reference. Our reference thus comprises 2028 *Agalychnis callidryas* reference sequences (contigs) (1,052,683 bps total).

I used archived UCE data to create a reference UCE file for alignment. This is in `/uufs/chpc.utah.edu/common/home/gompert-group4/data/UCE_data/Reference`.

The reference was indexed with `samtools` (version 1.16) and `bwa` (version 0.7.17-r1198-dirty). 

```{bash}
cd /uufs/chpc.utah.edu/common/home/gompert-group4/data/UCE_data/Reference
samtools faidx CleanUCE.fasta
bwa index CleanUCE.fasta
```
# Alignment and variant calling

The data were demultiplexed, filtered for quality and trimmed by RAPiD Genomics. I am working with the clean files from `/uufs/chpc.utah.edu/common/home/gompert-group4/data/UCE_data/PhylucePipeline/clean-fastq`. 

I aligned the data to the reference UCE set described above with mem algorithm from `bwa` (version 0.7.17-r1198-dirty).

```{bash}
#!/bin/sh
#SBATCH --time=96:00:00
#SBATCH --nodes=1
#SBATCH --ntasks=16
#SBATCH --account=wolf-kp
#SBATCH --partition=wolf-kp
#SBATCH --job-name=bwa
#SBATCH --mail-type=FAIL
#SBATCH --mail-user=zach.gompert@usu.edu

module load bwa 

cd /uufs/chpc.utah.edu/common/home/gompert-group4/data/UCE_data/Alignments

perl BwaAlignFork.pl CSN_1583*READ1.fastq.gz
```

```{perl}
#!/usr/bin/perl
#
# run bwa mem in parallel
#


use Parallel::ForkManager;
my $max = 16;
my $pm = Parallel::ForkManager->new($max);

my $genome = "/uufs/chpc.utah.edu/common/home/gompert-group4/data/UCE_data/Reference/CleanUCE.fasta";

## get ids
open(IN,"ids.txt") or die "failed to read the ID file\n";
<IN>; # burn header
while(<IN>){
	chomp;
	@line = split(/\s+/,$_);
	$itab{$line[0]} = $line[1];
}
close(IN);

foreach $file1 (@ARGV){
    $pm->start and next; ## fork
    $file2 = $file1;
    $file2 =~ s/READ1/READ2/ or die "failed file sub\n";
    $file1 =~ m/^(CSN_\d+_P\d+_[A-Z0-9]+)/ or die "failed id match\n";
    $pid = $1;
    $id = $itab{$pid};

    print "Working on $pid = $id\n";    
    	
    system "bwa mem -t 1 -M -r 1.3 -k 19 -R \'\@RG\\tID:$id\\tPL:ILLUMINA\\tLB:$id\\tSM:$id\' -o $id".".sam $genome $file1 $file2\n";
    $pm->finish;
}
 

$pm->wait_all_children;
```
